# Домашнее задание к занятию "Резервное копирование баз данных" - Карпов Антон Юрьевич

## Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

## Решение 1

#### 1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

Подойдет полное (full backup) ежедневное копирование (лучше ночью в период минимальной нагрузки).

#### 1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

Инкрементный бэкап - полная копия, например, раз в неделю. И ежечасно - инкрементные копии.

Либо дифференциальный - полная копия раз в неделю, дифференциальная - раз в день, ежечасно - инкрементная.

#### 1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Это возможно в случае с репликацией БД - при аварии мастера запросы уходят на slave вручную, либо автоматически. В этом случае желательна синхронная репликация, т.к. до момента переключения новые запросы могут не дойти до реплики, которая станет мастером.

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

## Решение 2

#### 2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Использую документацию:
https://postgrespro.ru/docs/postgresql/current/app-pgdump
https://postgrespro.ru/docs/postgresql/current/app-pgrestore

Для снятия дампа команда: 
pg_dump [параметр-подключения...] [параметр...] [имя_бд]

Пример:
```
pg_dump -U postgres -F c mydb > mydb_dump_20262701
```
-F c - формат, пригодный для дальнейшего восстановления с помощью pg_restore.

Для восстановления:
pg_restore [параметр-подключения...] [параметр...] [имя_файла]

Пример:
```
dropdb mydb
$ pg_restore -C -d postgres db.dump
```

-C - создает базу данных

#### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Возможно автоматизировать с помощью bash-скрипта и cron-задания.


## Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.

## Решение 3

#### 3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

С помощью бинарных логов. В конфигурационном файле MySQL (my.cnf или my.ini) в секции [mysqld] нужно добавить или раскомментировать следующие строки:

```
log_bin = mysql-bin  # имя префикса для файлов бинарных логов
binlog_format = ROW  # формат логирования (ROW — наиболее безопасный для восстановления)
expire_logs_days = 7  # удалять бинарные логи старше 7 дней
server_id = 1         # уникальный ID сервера
```
Перезапуск сервера Mysql:
```
sudo systemctl restart mysql
```

Полное резервное копирование:
```
mysqldump -u root -p --all-databases --master-data=2 > full_backup.sql
```
Далее очередь инкрементного копирования:
```
# Определить текущий активный бинарный лог
mysql -u root -p -e "SHOW MASTER STATUS\G"

# Скопировать все бинарные логи (начиная с точки после полного бэкапа)
cp /var/log/mysql/mysql-bin.* /backup/incremental/
```

#### 3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Репликация и РК - невзаимоменяемые вещи с разными задачами. Репликация служит в первую очередь для повышения производительности, распределения нагрузки и отказоустойчивости. В случае записи некорректных данных или, например, удаления таблиц, заражении вирусом, действия распространятся и на реплики, причем за такое время, что человек с огромной вероятностью среагировать не успеет. 

Резервное копирование же как раз и нужно в том числе и для таких случаев. 

Поэтому отдельно использовать эти 2 способа весьма опасно. Лучше всего использовать эти 2 инструмента совместно.





















